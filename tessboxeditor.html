<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React Image Annotator</title>
    <style>
        body { font-family: Arial, sans-serif; }
        canvas { background: #f0f0f0; cursor: crosshair; }
        table { margin-top: 10px; }
        th, td { padding: 8px; text-align: left; }
        input[type="text"], button { width: 100%; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">

        const { useState, useRef, useEffect } = React;

        function ImageAnnotator() {
            const [image, setImage] = useState(null);
            const [rectangles, setRectangles] = useState([]);
            const [scale, setScale] = useState(1);
            const [originX, setOriginX] = useState(0);
            const [originY, setOriginY] = useState(0);
            const [dragStart, setDragStart] = useState(null);
            const [drawing, setDrawing] = useState(false);
            const [newRect, setNewRect] = useState(null);
            const [imageLoaded, setImageLoaded] = useState(false);
            const canvasRef = useRef(null);
            const imgRef = useRef(null);

            const handleImageChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setImage(e.target.result);
                        resetView();
                    };
                    reader.readAsDataURL(file);
                }
            };

            const resetView = () => {
                setOriginX(0);
                setOriginY(0);
                setScale(1);
                setImageLoaded(true);
            };

            const drawImageAndRectangles = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                if (imageLoaded) {
                    const img = imgRef.current;
                    ctx.save();
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.translate(originX, originY);
                    ctx.scale(scale, scale);
                    ctx.drawImage(img, 0, 0);
                    rectangles.concat(newRect ? [newRect] : []).forEach((rect) => {
                        ctx.strokeStyle = 'red';
                        ctx.beginPath();
                        ctx.rect(rect.x, rect.y, rect.width, rect.height);
                        ctx.stroke();
                        ctx.fillText(rect.label, rect.x, rect.y - 10, rect.width); // Ensure text fits in the rectangle
                    });
                    ctx.restore();
                }
            };

            useEffect(() => {
                drawImageAndRectangles();
            }, [rectangles, newRect, originX, originY, scale, imageLoaded]);

            const handleMouseDown = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const startX = (e.clientX - rect.left - originX) / scale;
                const startY = (e.clientY - rect.top - originY) / scale;
                setDrawing(true);
                setNewRect({ x: startX, y: startY, width: 0, height: 0, label: "New Annotation" });
            };

            const handleMouseMove = (e) => {
                if (drawing && newRect) {
                    const rect = canvasRef.current.getBoundingClientRect();
                    const moveX = (e.clientX - rect.left - originX) / scale;
                    const moveY = (e.clientY - rect.top - originY) / scale;
                    setNewRect({
                        ...newRect,
                        width: moveX - newRect.x,
                        height: moveY - newRect.y
                    });
                }
            };

            const handleMouseUp = () => {
                if (drawing) {
                    setRectangles(rectangles.concat(newRect));
                    setNewRect(null);
                    setDrawing(false);
                }
            };

            const handleWheel = (e) => {
                e.preventDefault();
                const rect = canvasRef.current.getBoundingClientRect();
                const x = (e.clientX - rect.left - originX) / scale;
                const y = (e.clientY - rect.top - originY) / scale;
                const deltaScale = e.deltaY * -0.005;
                const newScale = Math.max(scale + deltaScale, 0.1);
                setScale(newScale);
                setOriginX(originX - x * deltaScale);
                setOriginY(originY - y * deltaScale);
            };

            const updateLabel = (index, newLabel) => {
                const updatedRectangles = [...rectangles];
                updatedRectangles[index] = { ...updatedRectangles[index], label: newLabel };
                setRectangles(updatedRectangles);
            };

            return (
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                    <div>
                        <input type="file" onChange={handleImageChange} accept="image/*" />
                        <button onClick={resetView}>Reset View</button>
                    </div>
                    <canvas
                        ref={canvasRef}
                        width={800}
                        height={600}
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onWheel={handleWheel}
                        style={{ border: '1px solid black', margin: '10px' }}
                    />
                    <img ref={imgRef} src={image} alt="" style={{ display: 'none' }} />
                    <div>
                        <h3>Annotations</h3>
                        <table border="1">
                            <thead>
                                <tr>
                                    <th>Label</th>
                                    <th>X</th>
                                    <th>Y</th>
                                    <th>Width</th>
                                    <th>Height</th>
                                </tr>
                            </thead>
                            <tbody>
                                {rectangles.map((rect, index) => (
                                    <tr key={index}>
                                        <td>
                                            <input type="text" value={rect.label} onChange={(e) => updateLabel(index, e.target.value)} />
                                        </td>
                                        <td>{Math.round(rect.x)}</td>
                                        <td>{Math.round(rect.y)}</td>
                                        <td>{Math.round(rect.width)}</td>
                                        <td>{Math.round(rect.height)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<ImageAnnotator />, document.getElementById('root'));

    </script>
</body>
</html>
